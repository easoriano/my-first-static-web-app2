<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vanilla JavaScript App</title>
  <script src="https://unpkg.com/@azure/ms-rest-js"></script>
  <script src="https://unpkg.com/@azure/cognitiveservices-computervision"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sharp/0.29.3/sharp.min.js" integrity="sha512-/ilxZU6lKU6X2U6/1U6kc+0jZw0G7Oz6LrUx+IATy5NfOLN+jD+FAp5D5O5ZMz5q3jJZ0EDbcBROQ+b5Y5yj9g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
  <main>
    <h1>Vanilla JavaScript App</h1>
    <input type="file" id="inputFile" accept="image/*" multiple>
    <div id="outputImages"></div>
  </main>

  <script>
    const {
      ComputerVisionClient,
    } = window.ComputerVision;
    const { CognitiveServicesCredentials } = window.MsRest;
    const sharp = window.sharp;

    const subscriptionKey = 'bfeba954de8f417abaf31f3431231dc8';
    const endpoint = 'https://shreyascomputervision.cognitiveservices.azure.com/';

    const computervisionClient = new ComputerVisionClient(
      new CognitiveServicesCredentials(subscriptionKey),
      endpoint
    );

    const inputFile = document.getElementById('inputFile');
    inputFile.addEventListener('change', handleFiles, false);
    const outputImages = document.getElementById('outputImages');

    async function handleFiles(event) {
      const fileList = event.target.files;

      for (const file of fileList) {
        const imageBuffer = await file.arrayBuffer();

        try {
          const result = await computervisionClient.detectObjectsInStream(
            new Blob([imageBuffer])
          );

          const image = sharp(imageBuffer);

          for (const object of result.objects) {
            const left = object.rectangle.x;
            const top = object.rectangle.y;
            const width = object.rectangle.w;
            const height = object.rectangle.h;

            const text = `${object.objectProperty} (${object.confidence * 100}%)`;

            await image
              .composite([
                {
                  input: Buffer.from(
                    `<svg height="${height}" width="${width}">
                      <rect x="0" y="0" width="${width}" height="${height}" style="stroke:red;stroke-width:5;fill:none" />
                      <text x="5" y="${height - 30}" font-size="16" fill="red" font-family="Arial">${text}</text>
                    </svg>`
                  ),
                  left: left,
                  top: top,
                },
              ])
              .toBuffer()
              .then(data => {
                const img = new Image();
                img.src = URL.createObjectURL(new Blob([data], { type: 'image/png' }));
                outputImages.appendChild(img);
              });
          }
        } catch (error) {
          console.error('Error processing the image:', error);
        }
      }
    }
  </script>
</body>
</html>
